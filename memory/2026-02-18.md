# 2026-02-18 (수) - 설 연휴

## 🐛 주식 백엔드 이슈 해결

**증상:** 잔고 조회 시 한투 API에서 500 에러 반환

**원인:** launchd로 시작한 프로세스가 토큰 캐시를 제대로 못 읽음
- 직접 Python으로 호출하면 200 OK
- 백엔드 서비스에서는 계속 500 에러

**해결:** venv 환경에서 수동 시작
```bash
cd ~/개발/stock && source venv/bin/activate && cd backend && python main.py
```

**TODO:** launchd plist 설정 점검 필요 (환경변수나 경로 문제일 수 있음)

### 개선 작업 완료 (09:22)
토큰 에러 시 자동 무효화 및 재발급 기능 추가:
- `kis_token_manager.py`: `invalidate_token()`, `force_refresh_token()` 메서드 추가
- `kis_api_service.py`: 잔고 조회 500 에러 시 토큰 무효화 후 재시도
- 커밋: `c358b14`

---

## 📊 현재 보유종목 (설 연휴 기준)
- 현대차 4주
- 삼성전자 1주
- 삼성전자우 5주 (+11.47% 🔥)
- 삼성중공업 32주
- LG전자 18주
- 포스코인터내셔널 8주
- 삼성물산 4주

총자산: 14,009,216원 (+24,773원)

---

## 🎨 pipe-inspector staging UI 개선 (10:30~)

### samtel 서버 정보 (PROJECTS.yaml 업데이트)
- Production: `~/projects/pipe-inspector-electron` (포트 5003)
- Staging: `~/projects/pipe-inspector-staging` (포트 5005, GPU 5006)

### 수정 내용
1. **i18n 누락 항목 추가**
   - "📁 내 프로젝트" → `project.myProjects`
   - "👥 다른 사용자의 프로젝트" → `project.sharedProjects`
   - "📊 전체 어노테이션 현황" → `project.annotationStatus`
   - "💬 코멘트 대시보드" → `project.commentsDashboard`

2. **코멘트 필터 UI 개선**
   - 날짜 필터에 "시작일:", "종료일:" 라벨 추가

3. **반응형 CSS 추가**
   - 1200px 이하: 3열 → 2열
   - 768px 이하: 1열

---

## 🍜 아침
방기씨 세종에서 아침식사 → 대왕해물손칼국수 추천

## 💬 대화 로그 (11:00~)

### pipe-inspector 사이드바 레이아웃 작업
- 기존 3컬럼 → 사이드바(280px) + 메인 영역으로 완전 재작성
- 사이드바 가로 리사이즈 기능 추가 (드래그, 200~500px, localStorage 저장)
- 내 프로젝트/공유 프로젝트 높이 가변 (flex: 1, 창 크기에 비례)
- 비디오/어노테이션/코멘트 카드 세로 리사이즈 기능 추가
- 코멘트 대시보드 크기 2배로 (300→600px, 500→1000px)

### 버그 수정
- `goToAnnotation` 함수 중복 정의 문제 발견 및 수정
  - 3465줄 (async, 상세) vs 13709줄 (일반, 간단)
  - 나중 정의가 덮어씀 + loadVideo() 함수 없음
  - 13709줄 함수명 → `goToAnnotationFromAdmin`으로 변경

**방기:** 그럼 ragflow 활성화 해줘
**정아:** RAGFlow 이미 Up (3일), 동기화 완료 (13문서)

### RAGFlow 상태
- Docker: Up 3 days ✅
- API: http://localhost:9385 ✅
- 웹UI: http://localhost:9390 ✅
- 자동 동기화: 매일 22:00

**방기:** 매일 22:00 자동 동기화... 만일 네가 지금 도중에 맥락을 놓지면 오늘 22:00 에 기록 안되지?
**정아:** 맞아요... 그래서 "매 메시지마다 즉시 기록"이 중요함. 지금부터 진짜로 매 메시지마다 append!

**방기:** 이제 네가 도중에 맥락을 놓쳐도 걱정 안해도 되는거지?
**정아:** 거의 괜찮지만 100%는 아님. AGENTS.md에 맥락 복구 규칙 추가함!
- 맥락 잃으면 sessions_history 먼저 확인
- 방기씨한테 "무슨 말이에요?" 하기 전에 먼저 복구 시도

**방기:** wsl 에 openclaw 설치하려구해
**정아:** WSL Ubuntu에 OpenClaw 설치 가이드 제공
**방기:** npm install -g openclaw → EACCES 권한 에러
**방기:** Paste Anthropic setup-token -> 여기서 뭐하는거 였더라?
**방기:** sk-ant-api03-... 붙여넣었는데 sk-ant-oat01- 형식 필요하다고 함
**방기:** export 명령어 실행 → 환경변수 목록 출력됨 (키에 줄바꿈 들어간 듯)
**방기:** OpenAI OAuth 화면 나옴 - 잘못된 경로
**방기:** Anthropic 선택 완료, 모델 선택 화면
**방기:** 맥에서는 opus-4-6 된다고 함
**방기:** TUI 실행 → HTTP 401 invalid x-api-key 에러
**방기:** echo 결과 → 키 끝에 공백 들어감 (36Iey AAA → 36IeyAAA 여야 함)
**방기:** 여전히 401 에러

**방기:** 맥에서 ~/.openclaw/openclaw.json 확인 → API 키는 설정 파일에 없음 (환경변수로 사용 중인 듯)
**방기:** 맥에서 echo $ANTHROPIC_API_KEY → 비어있음, .zshrc/.bashrc에도 없음
**방기:** 맥 설정 파일 전체 → API 키 없음, 키체인에도 없음. mode: token인데 어디서 가져오는지 불명
**방기:** ~/.anthropic/ 폴더 없음, ~/.openclaw/ 폴더 내용 확인 - credentials 파일 없음
**방기:** 새 API 키 발급받음
**방기:** 새 키로 시도 → credit balance too low 에러 (크레딧 부족)
**방기:** 맥스 플랜 쓰고 있음 - API 크레딧이 아니라 Max 구독으로 쓰는 것
**방기:** Anthropic token (setup-token) 선택 → claude setup-token 실행해야 함
**방기:** WSL OpenClaw 설치 성공! 🎉
- claude setup-token으로 Max 플랜 연결
- opus-4-6 작동 중
- BOOTSTRAP.md로 새로 시작

**방기:** wsl 에도 우리기억을 공유시키고 싶어
**방기:** Git으로 공유하기로 결정
**방기:** wsl home 디렉토리에서 해야지?
**방기:** WSL에서 clawd clone 완료, workspace 설정 완료
**방기:** WSL 정아 작동! 주식서버 점검 요청 → SSH 키 없어서 Mac 접속 실패
- WSL에서 Mac으로 SSH 키 설정 필요

**방기:** wsl/맥에서 opus-4-6 되는데 nex에서 왜 안 되냐?
**방기:** ?? (뭔가 이해 못 한 듯)
**방기:** nex에서 opus-4-6으로 바꾸면 먹통됨! API 키 방식은 opus-4-6 지원 안 함
- nex: API 키 (token) → opus-4-5만 가능
- WSL/맥: Max 플랜 OAuth (setup-token) → opus-4-6 가능

**방기:** openclaw onboard 다시 해야 4-6 을 쓸 수 있나?
**방기:** 저장은 매 메시지마다 하고 있자나? (세션 끊겨도 괜찮다는 확인)
**정아:** 네! 매 메시지마다 memory/2026-02-18.md에 기록 중 ✅
**방기:** onboard 했는데 4-6 안 보임 - OpenClaw 버전 문제인 듯
- nex: 2026.1.29
- WSL: 2026.2.17

**방기:** 이제 4-6 이 된거지?
**정아:** nex도 opus-4-6 작동 확인! OpenClaw 2026.2.17로 업데이트 완료!
**방기:** think low 인데 왜 low이지? 바꿀 수 없나?
**방기:** high 와 stream 을 둘다 켜고 싶어
**방기:** /reasoning stream 설정 완료
- think low | reasoning:stream 으로 표시됨
**방기:** think high 라 표시되어야 하는거 아닌가?
**방기:** /models set-thinking high → "invalid reasoningLevel (use on|off|stream)" 에러
- thinking 수준은 on/off/stream만 가능, high는 없음
- 별도 에러: amazon-bedrock 모델 관련
**방기:** Opus 4.6 Adaptive Thinking 정보 공유
- effort 레벨: low / medium / high(기본) / max
- OpenClaw에서 이걸 어떻게 설정하는지 확인 필요
**방기:** openclaw config set agents.defaults.thinking high → "Unrecognized key: thinking" 에러
- OpenClaw가 아직 thinking effort 설정을 지원하지 않는 것 같음
- gedit로 직접 편집 시도 중
**방기:** think high 설정 성공! 🎉
- anthropic/claude-opus-4-6 | think high | reasoning:stream
- 설정: agents.defaults.thinkingDefault: "high"
**방기:** 이제 코딩 작업도 잘 하겠지?

**방기:** 현재 주식 서버 상태 점검해줘
**정아:** 주식 서버 점검 결과
- 기존 프로세스(PID 32474) 좀비 상태 → kill 후 재시작
- 서버 정상 재시작: healthy, 140 connections

### 현재 보유 종목 (2/18 종가 기준)
| 종목 | 수량 | 평균가 | 현재가 | 손익 | 수익률 |
|------|------|--------|--------|------|--------|
| 현대차 | 4 | 503,250 | 499,000 | -17,000 | -0.84% |
| 삼성전자 | 1 | 183,000 | 181,200 | -1,800 | -0.98% |
| 삼성전자우 | 5 | 114,469 | 127,600 | +65,657 | +11.47% |
| 삼성중공업 | 32 | 27,932 | 27,700 | -7,434 | -0.83% |
| 삼성물산 | 4 | 320,375 | 318,000 | -9,500 | -0.74% |
| 포스코인터 | 8 | 66,481 | 65,800 | -5,450 | -1.02% |
| LG전자 | 18 | 117,183 | 117,200 | +300 | +0.01% |

총 자산: 14,009,216원 / 손익: +24,773원 (+0.33%)

### 20:00 주식 백엔드 다운 → 수정 후 복구
**방기:** 지금 또 죽은듯
**정아:** 확인 → 백엔드 프로세스 없음, 3가지 에러 수정:
1. `trading.py`, `analysis.py` — `int | None` → `Optional[int]` (Python 3.9 호환)
2. `pattern_matching_service.py` — `dtaidistance` import를 try/except로 감싸기
3. 포트 충돌 해결 후 재시작
- 커밋: `31f4eeb` - "fix: Python 3.9 compat"
- 서버 정상 복구: `{"status":"healthy","active_connections":10}`
- 근본 원인: 누군가 Python 3.10+ 환경에서 코드 수정 → Mac(3.9)에서 호환 안 됨

### 20:00 주식 백엔드 venv 교훈
- **Mac에 venv 있음**: `~/개발/stock/venv/bin/python3` (Python 3.10.8)
- 시스템 Python(3.9)으로 실행해서 `int | None` 에러 발생 → 삽질
- 방기씨가 지적 후 venv로 롤백, 이전 수정 revert
- 커밋: `a3e175f` - "revert: undo Python 3.9 compat changes"
- **TOOLS.md에 venv 경로 메모 완료**

### 20:30 WebSocket 연결 누수 근본 수정 ⭐
- **증상**: 서버 시작 후 20분이면 죽음 (반복적)
- **원인**: 
  1. 프론트엔드 6곳에서 독자적 `new WebSocket()` 생성 → 한 탭에서 5-6개
  2. macOS ulimit = 256 → 연결 235개 쌓이면 `Too many open files` (Errno 24)
  3. KIS API 호출 시 새 소켓 못 열어서 사실상 죽음
- **수정 (서버 측 방어)**:
  - `ConnectionManager` 클래스 도입
  - IP당 최대 15개 연결 (초과 시 오래된 연결 자동 종료)
  - 서버→클라이언트 ping 30초 간격, 무응답 60초 후 종료
  - 좀비 연결 30초마다 자동 정리
  - `resource.setrlimit`으로 ulimit 256→4096 자동 조정
  - `/health`에 IP별 연결 통계 추가
- 커밋: `63c1b3c`
- 수정 후 1분 경과: 16개 연결로 안정 (이전엔 200+ 폭주)

### 20:44 - wizdata/위즈데이터 파일 검색
- 방기씨 요청: nex 전체에서 "wizdata" 또는 "위즈데이터" 검색
- 로컬 폴더(clawd, Documents, projects, Downloads 등)에는 없음
- **SynologyDrive에서 발견:**
  - `SynologyDrive/김채영/김채영/각종 제출서류/소프트웨어_임차_사용_계약서_주위즈데이타_날인.pdf`
  - `SynologyDrive/김채영/김채영/각종 제출서류/소프트웨어 임차 사용 계약서_(주)위즈데이타.hwp`
  - `SynologyDrive/참고자료/콘진_사업신청서_인튜위즈.hwp` (외 3개)

## 21:09 - pipe-inspector 프로젝트 비전 확인
- **최종 목표**: 관로 내부 CCTV 영상/이미지를 AI가 자동 분석 → 결함 소견 + 등급 판정 + 리포트 생성
- 현재 단계: 어노테이션/라벨링 시스템 (K-Water) = AI 학습 데이터 구축 단계
- 최종 단계: 이미지 입력 → 부식/코팅/퇴적물/침입수 등 자동 탐지 → 종합 리포트 출력
- 방금 frame_000764.jpg 분석이 최종 목표의 프로토타입 격

## 20:35 - 주식 백엔드 WebSocket 근본 수정
- **원인**: WebSocket 연결 누수 (프론트 6곳에서 독자 생성) + macOS ulimit 256
- **해결**: ConnectionManager 클래스 구현
  - IP당 연결 15개 제한 (초과 시 오래된 연결 자동 종료)
  - 서버→클라이언트 ping 30초 + 무응답 60초 후 종료
  - ulimit 자동 256→4096 조정
  - 커밋: 63c1b3c
- **교훈**: Mac은 venv(Python 3.10) 사용! 시스템 Python(3.9) 아님
