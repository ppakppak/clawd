# 2026-02-17 (화)

## 🔧 HWPX 공동편집 워크플로우 확립

### 배경
- 방기씨가 HWP/HWPX 문서를 나와 함께 공동편집하고 싶다고 함
- 한컴독스는 API 없어서 접근 불가
- HWPX 직접 조작 방식으로 해결!

### HWPX 구조 (중요!)
```
├── mimetype              → application/hwp+zip
├── Contents/
│   ├── header.xml        → 스타일/폰트 정의
│   └── section0.xml      → 📄 본문 (핵심!)
├── BinData/              → 🖼️ 이미지들
├── Preview/
│   └── PrvText.txt       → 미리보기 텍스트
└── META-INF/             → 메타데이터
```

### 편집 방법
1. HWPX 압축 해제: `unzip file.hwpx -d content/`
2. XML 포맷팅: `xmllint --format section0.xml > section0_fmt.xml`
3. 텍스트 수정: `<hp:t>` 태그 안의 내용 수정
4. **중요**: `<hp:linesegarray/>` 비워두기! (안 그러면 글자 겹침)
5. 재압축: `zip -r output.hwpx mimetype version.xml Contents/ BinData/ ...`

### 작업 파일 위치
- 작업 디렉토리: `~/clawd/hwpx-analysis/`
- 원본: `/home/ppak/Documents/katok_talk/Documents/카카오톡 받은 파일/`

### 테스트 문서
- 연구개발계획서-PART2(본문1).hwpx - iPipeCheck 관로 진단 AI 솔루션
- "(라) 시장진입 및 마케팅 계획" 섹션 작성 완료

### 삽질 기록
- 처음에 `linesegarray`에 vertpos 값을 직접 넣었더니 글자가 겹침
- 해결: `<hp:linesegarray/>`로 비워두면 한글이 자동 레이아웃

---

## 📊 pipe-inspector-electron 라벨링 현황 점검

### 배경
- 방기씨가 프로젝트 점검 요청
- 컨텍스트 truncate로 이전 대화 날아감 😅

### 라벨링 통계
- **저장 위치**: `/home/intu/Nas2/k_water/pipe_inspector_data` (NAS2)
- **총 라벨링 프레임**: **22,611건**
- **annotation JSON 파일**: 676개
- **활성 사용자**: 약 20명 (김종석, 손희동, 박영기 등)

### 주요 프로젝트 (jsKim 기준)
| 프로젝트 | 비디오 수 | 라벨 수 |
|---------|----------|--------|
| SP_광역_관내시경 | 109 | 733 |
| PE관종_등 | 152+ | - |
| DCIP_지방_관내시경 시리즈 | 여러개 | - |

### 라벨 클래스
- rust (부식)
- scale (스케일)
- 기타 관로 결함 유형들

### 시스템 구조
```
samtel (192.168.0.32) → backend_proxy.py (port 5003)
                     → gpu-server/api.py (inference)
                     ↓
               NAS2 (192.168.0.119) - 실제 데이터 저장
```

---

## 🔄 pipe-inspector 스테이징 환경 구축

### 완료!
- **Production**: ~/projects/pipe-inspector-electron (포트 5003, 5004)
- **Staging**: ~/projects/pipe-inspector-staging (포트 5005, 5006)

### 생성한 스크립트
- `start-staging.sh` - 스테이징 서버 시작 (가상환경 자동 활성화)
- `stop-staging.sh` - 스테이징 서버 중지
- `test-staging.sh` - 자동 테스트
- `deploy-to-production.sh` - 프로덕션 배포 (자동 백업 포함)
- `STAGING_README.md` - 사용법 문서

### 워크플로우
1. staging에서 코드 수정
2. start-staging.sh로 테스트
3. 브라우저에서 http://192.168.0.32:5005 확인
4. deploy-to-production.sh로 배포

### 주의
- staging과 production은 같은 NAS 데이터 공유
- 모델 파일(.pth)은 별도 관리 (배포 시 복사 안 함)

---

## 🔧 빠진 crontab 항목 (나중에 추가)

비디오 새로 추가되면 그때 crontab에 추가:
```bash
0 0 * * * /home/intu/projects/pipe-inspector-electron/scheduled_video_conversion.sh >> /home/intu/projects/pipe-inspector-electron/scheduled_conversion_cron.log 2>&1
```
- 매일 자정~09시 자동 변환
- AVI → MP4 변환 (관내시경영상, SAHARA 폴더)

---

## 🚀 pipe-inspector 스테이징 성능 개선

### 1. 대시보드 로딩 속도 개선 ✅
**문제:** 데이터셋 탭 진입 시 20-30초 걸림
**원인:** `/api/admin/dashboard`가 676개 JSON 파일을 매번 열어서 파싱
**해결:** 캐시 시스템 추가
- `_load_dashboard_cache()` / `_save_dashboard_cache()` 함수 추가
- 5분 TTL + 어노테이션 변경 시 자동 무효화
- 캐시 파일: `.admin_dashboard_cache.json`
- **결과:** 첫 로드 후 즉시 로딩!

### 2. 데이터셋 빌드 속도 개선 ✅
**문제:** 459개 이미지 빌드에 6분 소요
**원인:** 프레임마다 비디오 파일 열고 닫음 (459번!)
**해결:** `process_frames()` 함수 최적화
- 비디오별 프레임 그룹화 (같은 비디오 한 번만 열기)
- 프레임 번호 순 정렬 (순차 읽기 최적화)
- ThreadPoolExecutor로 4개 비디오 병렬 처리
- **예상:** 6분 → 1-2분

### 3. 비디오 경로 .avi → .mp4 문제
- 어노테이션 JSON에는 `.avi` 경로
- 실제 파일은 `.mp4` (변환 완료됨)
- 스테이징 코드에 이미 fallback 로직 있음 → 빌드 성공!

### 참고: 프레임 캐시 아이디어
- 이미 라벨링된 데이터는 프레임 이미지 없음 (비디오에서 추출 필요)
- 향후 새 라벨링 시 프레임 캐시하면 빌드 즉시 가능
- 현재는 비디오 그룹화 + 병렬 처리가 현실적 최선

---

## 💬 대화 로그 (20:30~)

**방기:** 아 그리고 지금 대화하는 내용은 로컬 메모리에 계속 저장하고 있는건가?
**정아:** 솔직히 중간에 못 했어요... 지금 업데이트할게요!

**방기:** 즁간중간이라는 말은 너무 모호한데?
**정아:** 기록 시점 규칙 제안 (문제 발견, 수정 완료, 결정사항 등)

**방기:** 내가 어떤 말을 하고 엔터를 칠때마다로 하면 안되나?
**정아:** 매 메시지마다 기록하면 절대 안 놓침, 규칙 명확함

**방기:** 모두 기록해줘
**정아:** ✅ 앞으로 모든 대화 기록!

**[HEARTBEAT 20:45]** - 작업 중 (pipe-inspector 빌드 최적화)

**방기:** 빌드 결과 - 21:01:01 → 21:05:25 (약 4분 24초)
**정아:** 6분 → 4.5분... 25% 개선 😕 기대만큼은 아님

**방기:** 지금까지 Staging 코드에만 손댄거지?
**정아:** 네 맞아요! Production은 안 건드림

**[HEARTBEAT 21:05]** - 작업 중, 프로덕션 배포 논의 중

---

## 기타

### SSH 설정 수정
- `~/.ssh/config`에서 `Host 192.168.0.18`에 `IdentityFile ~/.ssh/id_mac` 추가
- 이전에는 `Host mac`에만 설정되어 있어서 IP로 접속하면 실패했음

### 모닝 브리핑
- 08:38 진행
- 미국 증시: 다우 +0.10%, 나스닥 -0.22%
- 오늘 일정: 14:00 주간 미팅
- 날씨: 대전 -7°C 맑음
