# 2026-02-03

## 주식 트레이딩 시스템 - 딥바이 매도 로직 버그 수정

### 문제
- 두산에너빌리티(034020) 오늘 **의도치 않게 5번 연속 매도** 실행됨
- 원인: 티어 간 쿨다운(60초)이 너무 짧아서 수익률이 여러 티어를 초과할 때 연속 매도 발생
- 기대 동작: 1.5% 도달 시 15% 매도 후 **멈춰야 함**

### 수정 내용 (v2.4)
**파일:** `backend/services/samsung_deep_buy_service.py`

1. **티어 쿨다운을 시간 기반으로 변경**
   - 기존: 수익률이 이전 티어 아래로 떨어져야 다음 티어 실행
   - 변경: **30분 간격**으로 다음 티어 실행 허용 (`TIER_COOLDOWN_SECONDS = 1800`)

2. **새 클래스 변수**
   ```python
   _last_tier_sell_time: Dict[str, datetime] = {}
   _tier_mutex = threading.RLock()
   TIER_COOLDOWN_SECONDS = 1800
   ```

3. **새 메서드**
   - `set_tier_sell_time(stock_code)`: 매도 후 시간 기록
   - `check_tier_cooldown(stock_code, profit_rate)`: 30분 경과 여부 체크
   - `get_tier_cooldown_remaining(stock_code)`: 남은 쿨다운 시간 반환
   - `clear_tier_cooldown(stock_code)`: 쿨다운 초기화

4. **로직 흐름**
   ```
   1.5% 도달 → Tier 1 매도 → 30분 쿨다운 시작
   [30분 후]
   2.0% 도달 → Tier 2 매도 → 30분 쿨다운 시작
   ...
   ```

### 백업
- 원본: `backend/services/samsung_deep_buy_service.py.bak`

### 상태
- 패치 적용 완료, 문법 검증 통과
- **백엔드 재시작 필요** (`./restart_all.sh`)

### 딥바이 매도 티어 설정 (참고)
| 티어 | 수익률 | 매도 비율 |
|------|--------|----------|
| 1 | 1.5% | 15% |
| 2 | 2.0% | 20% |
| 3 | 2.5% | 25% |
| 4 | 3.0% | 30% |
| 5 | 3.5% | 35% |
| 6 | 4.0% | 40% |
