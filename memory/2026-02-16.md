# 2026-02-16 (월)

## 🐄 cattle-estrus-detection 프로젝트 수정

### YOLOv8 학습 명령어 버그 수정 (14:07)
- 문제: `python -m yolo` → `No module named yolo` 에러
- 원인: ultralytics는 `python -m yolo`가 아니라 `yolo` CLI 사용
- 수정: `backend/api/routes/training.py`
  - `["python", "-m", "yolo", ...]` → `[str(venv_yolo), ...]`
  - venv의 yolo CLI 직접 호출하도록 변경

### Detection 페이지 모델 선택 기능 추가 (14:30~15:00)
- 요청: 학습된 모델로 추론할 수 있게 해달라
- 구현:
  1. **Backend** (`detection.py`)
     - `GET /api/detection/models` - 모델 목록 API 추가
     - WebSocket에 `model_path` 파라미터 추가
  2. **Backend** (`video_processor.py`)
     - `initialize(model_path)` - 동적 모델 로딩
     - `_resolve_model_path()` - 모델 경로 결정 로직
  3. **Frontend** (`Detection.tsx`)
     - 모델 선택 드롭다운 추가
     - 학습된 모델 / 사전학습 모델 그룹 분리

### 학습된 모델 위치
- `runs/train/cattle_v1/weights/best.pt`
- `runs/detect/runs/train/cattle_behavior/weights/best.pt`

---

## 🏷️ 라벨 검토 페이지 추가 (15:30~16:00)

### 구현
- `/review` 페이지 - 라벨 시각화 및 수정
- `backend/api/routes/labels.py` - 라벨 API
- `frontend/src/pages/LabelReview.tsx` - 라벨 검토 UI

### 기능
- 이미지 그리드 + 라벨 유무 표시
- 폴리곤 시각화 (cattle=초록, mounting_cow=빨강)
- 클래스 변경, 라벨 삭제
- train/val 필터, 라벨 유무 필터

---

## 🧹 라벨 정리 (16:00~)

### 문제 발견
- SAM 라벨링 시 작은 폴리곤 조각들이 너무 많이 생성됨
- 예: 한 이미지에 110개 라벨 (대부분 4~20 포인트 노이즈)
- 이게 학습 실패 원인! (mAP 6.8%)

### 해결
1. **정리 스크립트**: `scripts/clean_labels.py`
   - 최소 포인트 50개 이상
   - 최소 면적 0.1% 이상
   - 이미지당 가장 큰 라벨 1개만 유지
   - 결과: 2,193개 → 106개

2. **SAM 라벨링 코드 수정**: `backend/api/routes/sam.py`
   - 면적 필터링 추가
   - 폴리곤 단순화 (approxPolyDP)
   - 가장 큰 폴리곤 1개만 저장

### 재학습 결과 (16:30)
- 정리된 106개 라벨로 재학습
- **mAP50: 6.8% → 80.3%** 🎉
- **Mask mAP50: 81.4%**
- mounting_cow: mAP50 92.5%, Recall 93.3%

---

## 🎨 세그멘테이션 마스크 시각화 (17:00)

### 수정 파일
- `src/detection/detector.py` - `detect_with_masks()` 메서드 추가
- `backend/services/video_processor.py` - 마스크 오버레이 그리기

### 기능
- 반투명 마스크 오버레이 (cattle=초록, mounting_cow=빨강)
- 마스크 윤곽선 그리기
- 바운딩 박스 대신 폴리곤 시각화

---

## 🧭 네비게이션 통일 (17:30)

모든 페이지에 공통 네비게이션 추가:
- Detection.tsx, Labeling.tsx, Training.tsx, LabelReview.tsx
- 🎬 감지 / 🎨 라벨링 / 🏷️ 검토 / 🚀 학습

---

## 🔄 라벨 동기화 및 정리 (19:00~)

### 문제
- 라벨링 페이지는 `behavior_dataset`(원본)에 저장
- 학습은 `behavior_segment`(정리본) 사용
- 새 라벨이 자동으로 학습용에 반영 안 됨

### 해결
1. 수동 동기화 스크립트로 새 라벨 복사
2. min_points를 50→30으로 낮춤 (작은 폴리곤도 유지)
3. 빈 라벨 파일 삭제 (정리 스크립트로 내용 제거된 것들)
4. API 수정: 빈 파일은 "라벨 없음"으로 처리

### 최종 데이터셋
- Train: 99개
- Val: 23개
- 총: 122개

---

## 🔁 검토 페이지 SAM 재라벨링 기능 (19:30)

### 요청
- 검토 페이지에서 라벨 삭제하고 다시 SAM으로 라벨링할 수 있게

### 구현
1. **LabelReview.tsx**
   - "🗑️ 모두 삭제" 버튼 - 현재 이미지의 모든 라벨 일괄 삭제
   - "🎨 SAM 라벨링" 버튼 - 현재 이미지를 가지고 라벨링 페이지로 이동

2. **Labeling.tsx**
   - URL 파라미터 `?image=...` 지원
   - 전달받은 이미지 자동 선택

### 사용 흐름
1. 검토 페이지에서 잘못된 라벨 발견
2. "모두 삭제" → 라벨 제거
3. "SAM 라벨링" → 라벨링 페이지로 이동 (이미지 자동 선택)
4. SAM으로 다시 라벨링

### 커밋
- `7a630ff` feat(review): 검토 페이지에서 라벨 삭제 후 SAM 재라벨링 기능

---

## 🔀 라벨링/검토 페이지 통합 (19:45~20:05)

### 요청
- "라벨검토와 라벨링이 두개로 나뉘어질 이유가 없다"

### 구현
- **LabelReview.tsx 삭제**, Labeling.tsx에 통합
- `/review` → `/labeling` 리다이렉트

### 통합된 Labeling 페이지 구성
- **왼쪽**: 이미지 목록 + 필터 (train/val, 라벨유무)
- **중앙**: 캔버스 (기존 라벨 표시 + SAM 포인트 클릭)
- **오른쪽**: 
  - 클래스 선택
  - 기존 라벨 목록 (클래스 변경, 삭제)
  - SAM 마스크 후보 → 확정
  - 새 라벨 저장

### 백엔드 수정
- `sam.py`: append 옵션 추가 (기존 라벨에 새 라벨 추가)

### 커밋
- `938ea86` feat: 라벨링/검토 페이지 통합

---

## 🔑 SSH Mac 키 설정 해결 (20:40~20:57)

### 문제
- nex 서버 재시작 후 ssh-agent 초기화 → Mac 접속 불가
- 기존 키 (`~/.ssh/id_ed25519`)는 비밀번호 있어서 agent에 수동 등록 필요

### 해결
- 비밀번호 없는 새 키 생성: `~/.ssh/id_mac`
- Mac에 키 복사: `ssh-copy-id -i ~/.ssh/id_mac mac`
- SSH config에 별칭 추가: `Host mac`

### 결과
- 이제 서버 재시작해도 Mac 접속 가능
- heartbeat-state.json의 sshMac 이슈 해결됨

---

## 📈 주식 서버 상태 (21:00)

- 서버 정상 작동: `{"status":"healthy"}`
- 총자산: 14,009,216원 (프로그램 기준)
- 앱 표시: 14,115,553원
- **차이 원인**: D+2 결제 기준 (API는 결제 후 금액, 앱은 결제 전 예수금 포함)

---

### TODO
- 라벨링 후 자동 동기화 기능 고려

---

## ⚠️ 알려진 이슈
- SSH (Mac 192.168.0.18): 인증 실패 - 키 설정 필요
- Gmail: 토큰 만료 - 재인증 필요
