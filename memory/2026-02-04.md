# 2026-02-04

## 주식 트레이딩 시스템 - 트레일링 스톱 버그 수정 (v2.5)

### 문제
- 두산에너빌리티(034020) 어제(2/3), 오늘(2/4) 연속 **1주씩 여러 번** 매도됨
- 어제: 11:32:42~46 (4초 내 5회)
- 오늘: 09:08:05~09:08:56 (51초 내 4회) + 09:23 (5회)
- 원인: 매도 락(60초)이 너무 짧고, 락 획득이 티어 체크 후에 발생

### 수정 내용 (맥 환경 - /Users/ppak/개발/stock/)

**파일:** `backend/services/samsung_deep_buy_service.py`

1. **매도 락 시간 증가**
   ```python
   SELL_LOCK_SECONDS = 1800  # 60초 → 30분
   ```

2. **락 획득 시점 변경 (v2.5)**
   - 기존: 티어 체크 후 락 획득 → 동시 다발 매도 가능
   - 변경: 분석 시작 전 락 선점 → 한 번에 하나만 처리
   ```python
   # [v2.5] 매도 락 선점 - 분석 전에 락 획득
   if not cls.acquire_sell_lock(stock_code):
       return result  # 락 획득 실패 시 즉시 반환
   ```

3. **모든 HOLD 케이스에서 락 해제**
   - 티어 쿨다운 미충족 시 → 락 해제
   - 트레일링 스톱 대기 중 → 락 해제
   - 익절 기준 미달 시 → 락 해제

### 동작 흐름 (v2.5)
```
check_sell_signal() 호출
  ↓
락 선점 시도 (acquire_sell_lock)
  ├─ 실패 → 즉시 HOLD 반환
  └─ 성공 → 분석 진행 (30분간 유효)
       ↓
티어/트레일링 조건 체크
  ├─ 매도 조건 충족 → 매도 (락 유지)
  └─ 매도 안 함 → 락 해제 후 HOLD 반환
```

### 맥 백엔드 상태
- 10:58 재시작 완료
- v2.5 로그 정상 출력 확인

---

## 현대차(005380) 매수 로직 분석

### UI vs 실제 로직 불일치 발견

| 항목 | UI 표시 | 실제 로직 (scheduler.py) |
|------|---------|-------------------------|
| 기준가 | 마지막 매도가 (513,000원) | **평균가 (497,318원)** |
| 예상 매수가 | 507,870원 (매도가 -1%) | 평균가 미만 시 매수 |
| 조건 | 현재가 < 507,870 | 현재가 < 평균가 |

### 현재 상황 (11:05 기준)
- 현재가: 503,000원
- 평균가: 497,318원
- **수익 구간**이라 추가 매수 조건 미충족

### 매수 스케줄
- 삼성전자/삼성전자우: 10분 간격
- 현대차/두산에너빌리티: 30분 간격 (`:19`, `:49`분에만)

---

---

## 삼성전자 외국인/기관 매매동향 조회

### API 제한
- `get_investor_trend()` 함수: **30일까지만** 데이터 제공
- 60일 이상 요청 시 실패 (KIS API 제한)

### 2/3 예측 성공 케이스
- 2/2 마감: 외국인 -623만, 기관 -309만 (둘 다 매도) → 150,400원
- 2/3 결과: 외국인 +412만, 기관 +357만 (동반 매수 전환) → 167,500원 (+11.4%)
- 장전에 매수세 전환 포착 → 예측 성공

### 주요 패턴 (30일 데이터)
- 12/26: 외국인 +1,084만주 대량 매수 → 저점 대비 급등
- 1/21: 외국인 +660만주 → 상승
- 2/5: 외국인 -1,601만주 대량 매도 → 159,300원 하락

---

## 서버(nex) vs 맥 환경 차이

| 항목 | 서버(nex) | 맥 |
|------|----------|-----|
| 경로 | /home/ppak/stock | /Users/ppak/개발/stock |
| 코드 버전 | 구버전 (samsung_deep_buy_service.py 없음) | 최신 (v2.5) |
| SSH 접속 | localhost | ppak@192.168.0.18 |

**참고:** 서버(nex)에 적용한 sell_signal_service.py 수정은 맥 코드와 다름. 맥은 SamsungDeepBuyService가 딥바이 매도를 전담.
